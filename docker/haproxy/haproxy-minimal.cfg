global
    log stdout format raw local0 notice
    maxconn 10000
    tune.bufsize 65536
    tune.maxaccept 1000

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout http-request 30s
    timeout queue 2m
    timeout connect 15s
    timeout client 2m
    timeout server 2m
    timeout http-keep-alive 60s
    timeout check 15s
    maxconn 8000

# Statistics page for monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend for HTTP traffic
frontend http_frontend
    bind *:80

    # ACLs for routing
    acl is_api path_beg /api/
    acl is_static path_end .css .js .png .jpg .jpeg .gif .ico .svg .woff .woff2 .ttf .eot
    acl is_admin path_beg /admin/

    # Security headers for HTTP
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"

    # Routing based on content type
    use_backend static_backend if is_static
    use_backend api_backend if is_api
    use_backend admin_backend if is_admin
    default_backend laravel_backend

# Backend for main Laravel application
backend laravel_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    cookie LARAVEL_STICKY insert indirect nocache
    timeout server 30s
    timeout connect 5s

    # Nginx servers (not PHP-FPM directly)
    server nginx_1 nginx_1:80 check inter 3s rise 2 fall 3 maxconn 1000 cookie app1
    server nginx_2 nginx_2:80 check inter 3s rise 2 fall 3 maxconn 1000 cookie app2
    server nginx_3 nginx_3:80 check inter 3s rise 2 fall 3 maxconn 1000 cookie app3
    server nginx_4 nginx_4:80 check inter 3s rise 2 fall 3 maxconn 1000 cookie app4

# Backend for API requests
backend api_backend
    balance leastconn
    option httpchk GET /health
    http-check expect status 200
    timeout server 25s
    timeout connect 3s

    server nginx_1 nginx_1:80 check inter 2s rise 2 fall 2 maxconn 1500
    server nginx_2 nginx_2:80 check inter 2s rise 2 fall 2 maxconn 1500
    server nginx_3 nginx_3:80 check inter 2s rise 2 fall 2 maxconn 1500
    server nginx_4 nginx_4:80 check inter 2s rise 2 fall 2 maxconn 1500

# Backend for static content
backend static_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 20s

    server nginx_1 nginx_1:80 check inter 5s rise 2 fall 3 maxconn 2000
    server nginx_2 nginx_2:80 check inter 5s rise 2 fall 3 maxconn 2000
    server nginx_3 nginx_3:80 check inter 5s rise 2 fall 3 maxconn 2000
    server nginx_4 nginx_4:80 check inter 5s rise 2 fall 3 maxconn 2000

# Backend for admin interface
backend admin_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 30s
    timeout connect 10s

    server nginx_1 nginx_1:80 check inter 3s rise 2 fall 3 maxconn 200
    server nginx_2 nginx_2:80 check inter 3s rise 2 fall 3 maxconn 200
    server nginx_3 nginx_3:80 check inter 3s rise 2 fall 3 maxconn 200
    server nginx_4 nginx_4:80 check inter 3s rise 2 fall 3 maxconn 200
